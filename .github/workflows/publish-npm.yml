# NPM Publishing Workflow
#
# This workflow publishes the pdf-diff CLI package to npm using OIDC trusted publishing.
# 
# SETUP REQUIRED - npm Trusted Publishing (OIDC):
# -----------------------------------------------
# npm now requires OIDC trusted publishing or Granular Access Tokens (classic tokens are revoked).
# OIDC is recommended as it requires no secrets and is more secure.
#
# To enable OIDC trusted publishing:
# 1. Go to https://www.npmjs.com/package/@jamesmontemagno/pdf-diff/access
#    (You need to publish the package once first, see "First-time setup" below)
# 2. Click "Add a publishing configuration"
# 3. Select "GitHub Actions" as the provider
# 4. Enter:
#    - Repository: jamesmontemagno/pdf-diff
#    - Workflow filename: publish-npm.yml
#    - Environment: npm
# 5. Save the configuration
#
# First-time setup (before OIDC):
# -------------------------------
# For the FIRST publish only, you need a Granular Access Token:
# 1. Go to https://www.npmjs.com/settings/jamesmontemagno/tokens
# 2. Click "Generate New Token" > "Granular Access Token"
# 3. Set:
#    - Token name: pdf-diff-initial-publish
#    - Expiration: 7 days (shortest available)
#    - Packages: Select packages > @jamesmontemagno/pdf-diff
#    - Permissions: Read and write
# 4. Add as GitHub secret: NPM_TOKEN
# 5. Run this workflow once with dry_run=false
# 6. After successful publish, set up OIDC (above) and remove the NPM_TOKEN secret
#
# Alternative - Granular Access Token (if OIDC not desired):
# ----------------------------------------------------------
# 1. Go to https://www.npmjs.com/settings/jamesmontemagno/tokens
# 2. Click "Generate New Token" > "Granular Access Token"
# 3. Set:
#    - Token name: pdf-diff-github-actions
#    - Expiration: 90 days (maximum)
#    - Packages: Select packages > @jamesmontemagno/pdf-diff
#    - Permissions: Read and write
# 4. Add as GitHub secret: NPM_TOKEN
# 5. Set a reminder to rotate the token every 90 days
#
# Triggering a Release:
# --------------------
# This workflow runs when you:
# 1. Push a tag starting with 'v' (e.g., v1.0.0, v1.2.3)
#    git tag v1.0.0
#    git push origin v1.0.0
#
# 2. Manually trigger via GitHub Actions UI (workflow_dispatch)
#
# Before Publishing:
# -----------------
# 1. Update version in package.json
# 2. Update CHANGELOG if you have one
# 3. Commit changes
# 4. Create and push a tag

name: Publish to npm

on:
  push:
    tags:
      - 'v*'
    # Note: Path filters don't work with tags - tag pushes always trigger regardless of paths.
    # The tag itself indicates intent to publish a new version.
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (do not publish)'
        required: false
        default: false
        type: boolean
      first_publish:
        description: 'First time publish (use token, skip provenance)'
        required: false
        default: false
        type: boolean

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: npm  # GitHub environment for deployment protection and OIDC
    permissions:
      contents: write
      id-token: write  # Required for npm OIDC trusted publishing
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build CLI
        run: npm run build:cli

      - name: Verify CLI build
        run: |
          echo "Checking CLI build output..."
          ls -la dist-cli/
          echo "Testing CLI help..."
          node dist-cli/cli.mjs --help

      - name: Publish to npm (dry run)
        if: ${{ inputs.dry_run }}
        run: npm publish --dry-run --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      # First-time publish: Use NPM_TOKEN without provenance (OIDC not yet configured)
      - name: Publish to npm (first time - with token)
        if: ${{ !inputs.dry_run && inputs.first_publish }}
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      # Subsequent publishes: Use OIDC provenance (preferred - no token needed once configured)
      # Falls back to NPM_TOKEN if OIDC is not yet configured
      - name: Publish to npm (with provenance)
        if: ${{ !inputs.dry_run && !inputs.first_publish }}
        run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create GitHub Release
        if: ${{ !inputs.dry_run && startsWith(github.ref, 'refs/tags/') }}
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          body: |
            ## Installation
            
            ```bash
            # Use directly with npx
            npx @jamesmontemagno/pdf-diff original.pdf modified.pdf
            
            # Or install globally
            npm install -g @jamesmontemagno/pdf-diff
            ```
            
            See the [CLI documentation](https://www.pdf-diff.com/cli.html) for full usage instructions.
